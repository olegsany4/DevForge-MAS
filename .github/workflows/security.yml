# ===============================================================
# DevForge-MAS â€” CI: Security Checks (Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹, Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚)
# Ð¦ÐµÐ»Ð¸ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°:
# 1) ðŸ’¯ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð²ÐµÑÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð° (Ruff/Mypy/Bandit/Semgrep/Secrets/Deps)
# 2) ðŸ“ˆ ÐšÐ¾Ð»-Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº Ð½Ðµ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ°ÐµÑ‚ÑÑ â€” Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸
# 3) ðŸ”„ ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ actions, Ð±ÐµÐ· Ð½ÐµÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ñ„Ð»Ð°Ð³Ð¾Ð²
# 4) ðŸ§ª ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼Ð¾ÑÑ‚ÑŒ: Ð¼ÑÐ³ÐºÐ°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ñ src/, Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ Ð¸ Summary
# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾:
# - Ð“Ð¸Ð±ÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° mypy: Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑˆÐ°Ð³, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ .py Ð² src/, Ñ‡Ñ‚Ð¾Ð±Ñ‹ job Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»
# - Ð”ÐµÑ‚ÐµÐºÑ‚ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²: detect-secrets (advisory) + gitleaks (Ð¿Ð¾ action)
# - pip-audit/safety: advisory Ñ€ÐµÐ¶Ð¸Ð¼ (Ð½Ðµ Ð²Ð°Ð»Ð¸Ð¼ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹)
# - Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ $GITHUB_STEP_SUMMARY Ð¸ upload-artifact Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
# ===============================================================

name: security-checks

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - security-*
      # ÐŸÑ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸:
      # - main
      # - master

jobs:
  security:
    name: SAST & Secrets & Deps
    runs-on: ubuntu-latest

    # Ð¯Ð²Ð½Ñ‹Ðµ permissions â€” Ñ…Ð¾Ñ€Ð¾ÑˆÐ°Ñ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°. OIDC Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ð±ÑƒÐ´ÑƒÑ‰ÐµÐµ.
    permissions:
      contents: read
      security-events: write
      id-token: write

    steps:
      # --- 1) Checkout Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ (ÐºÐ°Ðº Ð±Ñ‹Ð»Ð¾) ---
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ history Ð¿Ð¾Ð»ÐµÐ·ÐµÐ½ Ð´Ð»Ñ gitleaks/semgrep, ÐµÑÐ»Ð¸ Ð½Ð°Ð´Ð¾

      # --- 2) Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ‚Ð¾Ñ€Ð° Python 3.11 ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð³Ð¾Ð½Ð¾Ð²

      # --- 3) Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² SAST/Deps/Secrets ---
      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install \
            ruff \
            mypy \
            bandit \
            semgrep \
            pip-audit \
            safety \
            detect-secrets
          # Ð”Ð»Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²/IaC Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð·Ð¶Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ trivy/hadolint/syft/grype Ð¸ Ñ‚.Ð¿.

      # --- 4) Ruff (Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³, Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ñ„Ð¸Ð´Ð±ÐµÐº) ---
      - name: Ruff
        run: ruff check .

      # --- 5) MyPy (Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ python-Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² src/) ---
      # Ð­Ñ‚Ð¾ Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ„ÐµÐ¹Ð» "There are no .py[i] files in directory 'src'".
      - name: MyPy (soft if no src/*.py)
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "src" ] && find src -type f -name "*.py" | grep -q .; then
            # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼; ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´Ñ‘Ñ‚, fallback Ð½Ð° Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹.
            mypy --strict src || mypy src
          else
            echo "No Python sources under src/. Skipping mypy (soft pass)."
          fi

      # --- 6) Bandit (SAST Ð´Ð»Ñ Python) ---
      - name: Bandit (SAST for Python)
        shell: bash
        run: |
          if [ -d "src" ] && find src -type f -name "*.py" | grep -q .; then
            bandit -q -r src -lll
          else
            echo "No Python sources under src/. Skipping bandit."
          fi

      # --- 7) Semgrep (Code scanning). Ð”ÐµÐ»Ð°ÐµÐ¼ Ð´Ð²Ð° Ð·Ð°Ñ…Ð¾Ð´Ð°, Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ â€” Ð±Ð¾Ð»ÐµÐµ ÑƒÐ·ÐºÐ¸Ð¹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ð·Ñ€Ñ. ---
      - name: Semgrep (advisory)
        shell: bash
        run: |
          # ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´: Ð±Ð¾Ð»ÐµÐµ ÑˆÐ¸Ñ€Ð¾ÐºÐ¸Ð¹ Ð¿Ñ€ÐµÑÐµÑ‚ Ð´Ð»Ñ CI
          semgrep ci --config p/ci --no-secrets-scan || \
          # Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´: ÐµÑÐ»Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð²Ð°Ð»Ð¸Ð»ÑÑ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑƒÐ¶ÐµÑÑ‚Ð¾Ñ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Python ERROR-ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ
          semgrep ci --severity ERROR --config p/python || true

      # --- 8) Detect-secrets (advisory) â€” Ð½Ðµ Ð²Ð°Ð»Ð¸Ð¼ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ ---
      - name: Detect Secrets (advisory)
        run: |
          detect-secrets scan --all-files > .secrets.report.json || true
          echo "Detect-secrets report saved to .secrets.report.json"

      # --- 9) Gitleaks (Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ action). ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ Ð½Ð°Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ð¸ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð². ---
      # Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÑÐµÐ³Ð´Ð° advisory â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ: continue-on-error: true
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          # ÐŸÑ€Ð¸ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿ÑƒÑ‚ÑŒ:
          # config-path: ".github/gitleaks.toml"
          additional-config: ""
        env:
          GITLEAKS_NOTIFY_DISABLE: "true"

      # --- 10) pip-audit (advisory) ---
      - name: Pip Audit (advisory)
        shell: bash
        run: |
          if [ -f "requirements.txt" ]; then
            pip-audit -r requirements.txt || true
          else
            echo "No requirements.txt. Skipping pip-audit."
          fi

      # --- 11) Safety (advisory) ---
      - name: Safety (advisory)
        shell: bash
        run: |
          if [ -f "requirements.txt" ]; then
            safety check -r requirements.txt || true
          else
            echo "No requirements.txt. Skipping safety."
          fi

      # --- 12) Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² (Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ) ---
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            .secrets.report.json
            sbom.json
          if-no-files-found: ignore

      # --- 13) Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Summary Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ Actions ---
      - name: Summary
        shell: bash
        run: |
          {
            echo "### Security checks â€” summary";
            echo "";
            echo "**Ruff**: Python style/lint â€” done";
            echo "**MyPy**: typed checks (soft if no src) â€” done";
            echo "**Bandit**: Python SAST (soft if no src) â€” done";
            echo "**Semgrep**: rulepacks p/ci â†’ fallback p/python ERROR â€” done";
            echo "**Secrets**: detect-secrets (advisory) + gitleaks â€” done";
            echo "**Deps**: pip-audit & safety (advisory) â€” done";
            echo "";
            echo "Artifacts (if any): \`.secrets.report.json\`, \`sbom.json\`";
          } >> "$GITHUB_STEP_SUMMARY"
